
{% extends "admin/base.html" %}

{% block title %}Admin Chat Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-comments me-2"></i>Chat Management</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-warning" onclick="clearAllChat()">
                        <i class="fas fa-trash me-2"></i>Clear All
                    </button>
                    <button class="btn btn-info" onclick="refreshChat()">
                        <i class="fas fa-sync me-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Chat Rooms Sidebar -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list me-2"></i>Chat Rooms</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action active" 
                           onclick="selectRoom('general', 'support')">
                            <i class="fas fa-comments me-2"></i>General Support
                            <span class="badge bg-primary rounded-pill float-end">{{ unread_count or 0 }}</span>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" 
                           onclick="selectRoom('wedding', 'help')">
                            <i class="fas fa-heart me-2"></i>Wedding Help
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" 
                           onclick="selectRoom('cv', 'help')">
                            <i class="fas fa-file-alt me-2"></i>CV Help
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" 
                           onclick="selectRoom('printing', 'help')">
                            <i class="fas fa-print me-2"></i>Printing Help
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Recent Messages -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6><i class="fas fa-clock me-2"></i>Recent Messages</h6>
                </div>
                <div class="card-body">
                    {% if recent_messages %}
                        {% for msg in recent_messages[:5] %}
                        <div class="d-flex mb-2">
                            <div class="flex-grow-1">
                                <small class="fw-bold">{{ msg.sender_name }}</small>
                                <small class="text-muted d-block">{{ msg.message[:50] }}...</small>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <small class="text-muted">Belum ada pesan</small>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Chat Window -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 id="current-room-title"><i class="fas fa-comments me-2"></i>General Support</h5>
                    <span class="badge bg-success">Admin Online</span>
                </div>
                
                <div class="card-body">
                    <!-- Chat Messages -->
                    <div class="chat-messages-container" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                        <div id="admin-chat-messages">
                            <!-- Messages akan dimuat di sini -->
                        </div>
                    </div>
                    
                    <!-- Chat Input -->
                    <div class="mt-3">
                        <div class="input-group">
                            <input type="text" class="form-control" id="admin-message-input" 
                                   placeholder="Ketik pesan..." onkeypress="handleAdminEnterKey(event)">
                            <button class="btn btn-primary" onclick="sendAdminMessage()">
                                <i class="fas fa-paper-plane"></i> Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
<script>
// Admin Chat Management
let adminSocket;
let currentAdminRoom = 'general';
let isAdminConnected = false;

// Initialize admin chat
function initializeAdminChat() {
    try {
        adminSocket = io({
            timeout: 10000,
            forceNew: true
        });
        
        adminSocket.on('connect', function() {
            console.log('Admin connected to chat server');
            isAdminConnected = true;
            adminSocket.emit('join_room', {room: currentAdminRoom});
            loadAdminChatHistory();
        });
        
        adminSocket.on('disconnect', function() {
            console.log('Admin disconnected from chat server');
            isAdminConnected = false;
        });
        
        adminSocket.on('receive_message', function(data) {
            displayAdminMessage(data);
        });
        
        adminSocket.on('error', function(data) {
            console.error('Admin chat error:', data.message);
            displaySystemMessage('Error: ' + data.message);
        });
        
        adminSocket.on('connect_error', function(error) {
            console.error('Admin connection error:', error);
            displaySystemMessage('Koneksi bermasalah. Mencoba ulang...');
        });
    } catch (error) {
        console.error('Failed to initialize admin chat:', error);
    }
}

function selectRoom(roomType, roomId) {
    const oldRoom = currentAdminRoom;
    currentAdminRoom = roomType;
    
    document.getElementById('current-room-title').innerHTML = 
        `<i class="fas fa-comments me-2"></i>${roomType.charAt(0).toUpperCase() + roomType.slice(1)} Room`;
    
    // Update active room in sidebar
    document.querySelectorAll('.list-group-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.classList.add('active');
    
    if (isAdminConnected) {
        // Leave current room and join new room
        adminSocket.emit('leave_room', {room: oldRoom});
        adminSocket.emit('join_room', {room: roomType});
    }
    
    loadAdminChatHistory();
}

function sendAdminMessage() {
    const messageInput = document.getElementById('admin-message-input');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    if (!isAdminConnected) {
        displaySystemMessage('Tidak terhubung ke server. Mencoba ulang...');
        initializeAdminChat();
        return;
    }
    
    try {
        adminSocket.emit('send_message', {
            message: message,
            room: currentAdminRoom,
            sender_type: 'admin',
            sender_name: '{{ session.admin_username }}',
            sender_email: 'admin@fajarmandiri.store',
            sender_id: null,
            room_type: 'general',
            room_id: 'support'
        });
        
        messageInput.value = '';
    } catch (error) {
        console.error('Error sending message:', error);
        displaySystemMessage('Gagal mengirim pesan: ' + error.message);
    }
}

function handleAdminEnterKey(event) {
    if (event.key === 'Enter') {
        sendAdminMessage();
    }
}

function displayAdminMessage(data) {
    const messagesContainer = document.getElementById('admin-chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'mb-3';
    
    let badgeClass = 'bg-secondary';
    if (data.sender_type === 'admin') {
        badgeClass = 'bg-primary';
    } else if (data.sender_type === 'user') {
        badgeClass = 'bg-success';
    } else if (data.sender_type === 'guest') {
        badgeClass = 'bg-warning';
    }
    
    messageDiv.innerHTML = `
        <div class="d-flex align-items-start">
            <span class="badge ${badgeClass} me-2">${data.sender_type.toUpperCase()}</span>
            <div class="flex-grow-1">
                <div class="fw-bold">${escapeHtml(data.sender_name)}</div>
                <div class="text-muted small mb-1">${data.timestamp}</div>
                <div class="message-content">${escapeHtml(data.message)}</div>
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function displaySystemMessage(message) {
    const messagesContainer = document.getElementById('admin-chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'mb-3 text-center';
    messageDiv.innerHTML = `
        <small class="text-muted fst-italic">${escapeHtml(message)}</small>
    `;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function loadAdminChatHistory() {
    fetch('/api/chat/history/general/support')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(messages => {
            const messagesContainer = document.getElementById('admin-chat-messages');
            messagesContainer.innerHTML = '';
            
            if (messages.length === 0) {
                displaySystemMessage('Belum ada percakapan di room ini');
                return;
            }
            
            messages.forEach(msg => {
                const timestamp = new Date(msg.timestamp).toLocaleTimeString('id-ID', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                displayAdminMessage({
                    sender_name: msg.sender_name,
                    sender_type: msg.sender_type,
                    message: msg.message,
                    timestamp: timestamp
                });
            });
        })
        .catch(error => {
            console.error('Error loading chat history:', error);
            displaySystemMessage('Gagal memuat riwayat chat');
        });
}

function clearAllChat() {
    if (confirm('Yakin ingin menghapus semua riwayat chat?')) {
        fetch('/admin/chat/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('admin-chat-messages').innerHTML = '';
                displaySystemMessage('Riwayat chat berhasil dihapus');
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error clearing chat:', error);
            alert('Gagal menghapus chat');
        });
    }
}

function refreshChat() {
    loadAdminChatHistory();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize admin chat when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeAdminChat();
});
</script>
{% endblock %}
